---
title: "ProyectoTD2025"
author: Jorge Ballesteros García, Emma Almenar García, Miguel Angel Aloy Poveda, Ainhoa
  Larios Bea, Samuel Lozada Borrás, Iker Martínez Bravo
date: "2025-04-07"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Carga de librerías

```{r}
# Asegurarse de que el paquete "pacman" está instalado
if (!require('pacman')) install.packages('pacman')

# Librerias a cargar
pacman::p_load(pdftools, tidyverse, readxl, lubridate, visdat, knitr, rticles, tinytex, kableExtra, patchwork, cowplot, wordcloud)


```



Vamos a crear una función que procese un ticket individual


```{r}

# Función para leer PDF y convertir en líneas de texto procesadas
leer_pdf <- function(archivo) {
  texto <- pdf_text(archivo)
  lineas <- unlist(strsplit(paste(texto, collapse = "\n"), "\n"))
  trimws(lineas)
}


#Función que busca "MERCADONA" en mayúsculas.
es_mercadona <- function(lineas) {
  if(length(lineas) == 0) return(FALSE)
  any(grepl("^MERCADONA\\b", lineas))  # ^ indica inicio de línea, \b para palabra completa
}

# Función para procesar las líneas y extraer información
procesar_lineas <- function(lineas) {
  if(!es_mercadona(lineas)) {
    message("El texto no corresponde a un ticket de Mercadona")
    return(NULL)
  }
  
#Inicializamos una lista para almacenar datos. Esta lista incluye los datos de tanto el encabezado, como los productos
  
  datos<-list(
    supermercado = NA,
    direccion = NA,
    cp = NA,
    localidad = NA,
    telefono = NA,
    fecha = NA,
    hora = NA,
    op = NA,
    factura_simplificada = NA,
    
#Creamos dentro de la lista para almacenar los datos, un dataframe que va a contener los productos del ticket.
    
    productos = data.frame(
      cantidad = numeric(),
      descripcion = character(),
      importe = numeric(),
      stringsAsFactors = FALSE
    ),
    parking = FALSE,
    hora_entrada_parking = NA,
    hora_salida_parking = NA,
    donacion = NA,
    metodo_pago = NA,
    tarjeta = NA,
    subtotal = NA,
    descuento = NA,
    IVA = NA,
    importe_total = NA
  )
  
  
  #Procesar encabezado:
  
  #Extraer el supermercado
  datos$supermercado<- trimws(lineas[1])
  datos$supermercado
  
  #Extraer la dirección
  datos$direccion<- trimws(lineas[2])
  datos$direccion
  
  #Extraer CP y localidad (ejemplo: "04630 GARRUCHA")
  
  localidad_cp<- trimws(lineas[3]) #Usamos trimws para asegurarnos de eliminar los espacios en blanco anteriores al CP.
  localidad_cp #CP y localidad juntos
  
  datos$cp<- gsub("([0-9]+).*", "\\1", localidad_cp) #Extraemos solo el CP.
  datos$cp
  
  datos$localidad<- gsub("[0-9]+ (.*)", "\\1", localidad_cp) #Extraemos solo la localidad
  
  datos$localidad
  
  #Extraer teléfono
  telefono_linea<-lineas[4]
  datos$telefono<- gsub(".*TELÉFONO: (.*)", "\\1", telefono_linea)
  datos$telefono
  
  #Extraer fecha, hora y OP
  fecha_hora_linea<- trimws(lineas[5]) # 25/11/2023 09:09 OP: 78800
  partes<-unlist(strsplit(fecha_hora_linea, " ")) #Separamos los elementos por espacios
  datos$fecha<-partes[1]
  datos$fecha
  datos$hora<- partes[2]
  datos$hora
  datos$op<- paste(partes[3],partes[4]) #Unimos los dos elementos en una cadena ("OP: 78800")
  datos$op
  
  #Extraer de la factura simplificada el código del ticket y el código del supermercado
  linea_factura_simplificada <- lineas[6]
  datos$factura_simplificada <- trimws(gsub("FACTURA SIMPLIFICADA:", "", linea_factura_simplificada))  
  componentes_factura_simplificada <- unlist(strsplit(linea_factura_simplificada, "-"))
  datos$num_tienda <- componentes_factura_simplificada[1] 
  datos$num_caja<- componentes_factura_simplificada[2] 
  datos$factura_numero <- componentes_factura_simplificada[3]
  
    # Función para buscar la línea de inicio de los productos
  buscar_inicio_productos <- function(lineas) {
    return(grep("^\\s*Descripción\\s+P\\. Unit\\s+Importe", lineas))
  }
  
  # Función para buscar la línea de fin de los productos
  buscar_fin_productos <- function(lineas) {
    return(grep("^\\s*TOTAL \\(€\\)", lineas)[1] - 1)
  }
  
  # Función para extraer productos normales (cantidad, descripción, [precio_unitario], importe)
    extraer_producto <- function(linea) {
    # Caso con precio_unitario y total
    match_con_unitario <- str_match(linea, "^\\s*(\\d+(?:[.,]\\d+)?)\\s+(.*?)\\s+(\\d+[.,]\\d+)\\s+(\\d+[.,]\\d+)$")
    if (!is.na(match_con_unitario[1,1])) {
      cantidad <- as.numeric(gsub(",", ".", match_con_unitario[1,2]))
      descripcion <- trimws(match_con_unitario[1,3])
      precio_unitario <- as.numeric(gsub(",", ".", match_con_unitario[1,4]))
      importe <- as.numeric(gsub(",", ".", match_con_unitario[1,5]))
      return(data.frame(cantidad = cantidad, descripcion = descripcion, precio_unitario = precio_unitario, importe = importe, stringsAsFactors = FALSE))
    }

    # Caso sin precio_unitario
    match_simple <- str_match(linea, "^\\s*(\\d+(?:[.,]\\d+)?)\\s+(.*?)\\s+(\\d+[.,]\\d+)$")
    if (!is.na(match_simple[1,1])) {
      cantidad <- as.numeric(gsub(",", ".", match_simple[1,2]))
      descripcion <- trimws(match_simple[1,3])
      importe <- as.numeric(gsub(",", ".", match_simple[1,4]))
      return(data.frame(cantidad = cantidad, descripcion = descripcion, precio_unitario = NA, importe = importe, stringsAsFactors = FALSE))
    }

    return(NULL)
  }
  
  # Función extraer_producto_peso
  extraer_producto_peso <- function(linea_actual, linea_siguiente) {
    match_peso <- str_match(linea_siguiente, "([0-9.,]+)\\s*kg\\s+([0-9.,]+)\\s*€/kg\\s+([0-9.,]+)")
    if (!is.na(match_peso[1,1])) {
      cantidad <- 1
      descripcion <- trimws(linea_actual)
      peso <- gsub(",", ".", match_peso[1,2])
      precio_kg <- gsub(",", ".", match_peso[1,3])
      importe <- gsub(",", ".", match_peso[1,4])
      descripcion_completa <- paste0(descripcion, " (", peso, " kg a ", precio_kg, " €/kg)")
      return(data.frame(cantidad = cantidad, descripcion = descripcion_completa, precio_unitario = as.numeric(precio_kg), importe = as.numeric(importe), stringsAsFactors = FALSE))
   }
    return(NULL)
  }
  
  # Función para procesar productos y agregar datos
  procesar_productos <- function(lineas) {
    linea_inicio_productos <- buscar_inicio_productos(lineas)
    if (length(linea_inicio_productos) > 0) {
     inicio <- linea_inicio_productos + 1
      fin <- buscar_fin_productos(lineas)

      if (!is.na(fin) && inicio < fin) {
        productos_brutos <- lineas[inicio:fin]
        i <- 1
        productos <- data.frame(cantidad = numeric(), descripcion = character(), importe = numeric(), stringsAsFactors = FALSE)

        while (i <= length(productos_brutos)) {
          linea <- productos_brutos[i]
        
         # Intentamos extraer el producto normal
          producto <- extraer_producto(linea)
          if (!is.null(producto)) {
            productos <- rbind(productos, producto)
            i <- i + 1
          } else {
            # Intentamos extraer un producto a peso si no es normal
            if (i < length(productos_brutos)) {
              linea_actual <- productos_brutos[i]
              linea_siguiente <- productos_brutos[i + 1]

             producto_peso <- extraer_producto_peso(linea_actual, linea_siguiente)
              if (!is.null(producto_peso)) {
                productos <- rbind(productos, producto_peso)
                i <- i + 2  # saltamos 2 líneas
              } else {
              i <- i + 1
              }
            } else {
              i <- i + 1
            }
          }
        }
        return(productos)
      }
    }
    return(NULL)
  }
  
  # Llamamos a procesar_productos para extraer los productos del ticket
  productos_extraidos <- procesar_productos(lineas)
  if (!is.null(productos_extraidos)) {
    datos$productos <- productos_extraidos  # Asignamos los productos al dataframe dentro de datos
  }  

  #Extraer IVA y subtotal
  linea_total_iva <- grep("^TOTAL\\s+[0-9.,]+\\s+[0-9.,]+$", lineas, value = TRUE)
  if (length(linea_total_iva) > 0) {
    partes <- unlist(strsplit(gsub(",", ".", linea_total_iva[1]), "\\s+"))
    datos$subtotal <- as.numeric(partes[2])
    datos$IVA <- as.numeric(partes[3])
  } else {
    datos$subtotal <- NA
    datos$IVA <- NA
  }
  
  #Extraer importe total
  linea_total <- grep("TOTAL \\(€\\)", lineas, value = TRUE)[1]
  if (!is.na(linea_total)) {
    datos$importe_total <- as.numeric(gsub(",", ".", gsub(".*TOTAL \\(€\\)\\s*([0-9.,]+).*", "\\1", linea_total)))
  } else {
    datos$importe_total <- NA
  }
  
  #Extraer descuento
  linea_descuento <- grep("DESCUENTO|DTO", lineas, value = TRUE, ignore.case = TRUE)
  if (length(linea_descuento) > 0) {
    datos$descuento <- as.numeric(gsub(",", ".", gsub(".*([0-9]+,[0-9]{2}).*", "\\1", linea_descuento[1])))
  } else {
    datos$descuento <- NA
  }
  
  #Extraer donación
  
  'linea_donacion <- grep("DONACIÓN", lineas, value = TRUE)
  if (length(linea_donacion) > 0) {
    datos$donacion <- as.numeric(gsub(",", ".", gsub(".*DONACIÓN:\\s*([0-9.,]+).*", "\\1", linea_donacion[1])))
  } else {
    datos$donacion <- NA
  }
  '
linea_donacion <- grep("DONACIÓN", lineas, value = TRUE)
if (length(linea_donacion) > 0) {
  # Busca el primer número con coma o punto como separador decimal
  nro <- str_extract(linea_donacion[1], "\\d+[\\.,]\\d+")
  if (!is.na(nro)) nro <- gsub(",", ".", nro)
  datos$donacion <- as.numeric(nro)
} else {
  datos$donacion <- NA
}
  #Obtenemos que solamente hay dos tickets con donación. Cada uno con una donación de 1€.
  #Estos son: 20231125 Mercadona 37,76 €.pdf y 
  
  #Extraer parking (hora entrada y salida si hay)
  linea_parking <- grep("PARKING", lineas)
if (length(linea_parking) > 0) {
  datos$parking <- TRUE
  # Buscar la línea siguiente que contenga ENTRADA y SALIDA
  for (i in seq_along(linea_parking)) {
    idx <- linea_parking[i] + 1
    if (idx <= length(lineas)) {
      linea_horas <- lineas[idx]
      if (grepl("ENTRADA", linea_horas) && grepl("SALIDA", linea_horas)) {
        datos$hora_entrada_parking <- gsub(".*ENTRADA\\s+([0-9:]{4,5}).*", "\\1", linea_horas)
        datos$hora_salida_parking <- gsub(".*SALIDA\\s+([0-9:]{4,5}).*", "\\1", linea_horas)
        break}
    }
  }
} else {
  datos$parking <- FALSE
}
  
  #Extraer método de pago
  linea_pago <- grep("TARJETA|MASTERCARD|EFECTIVO|DEBIT", lineas, value = TRUE, ignore.case = TRUE)
  if (length(linea_pago) > 0) {
    metodo <- grep("MASTERCARD|VISA|EFECTIVO|DEBIT|TARJETA", linea_pago, value = TRUE, ignore.case = TRUE)
    if (length(metodo) > 0) {
      datos$metodo_pago <- toupper(gsub(".*(MASTERCARD|VISA|DEBIT|EFECTIVO|TARJETA).*", "\\1", metodo[1]))
    } else {
      datos$metodo_pago <- NA
    }
  }
  
  #Extraer tarjeta
  linea_tarjeta <- grep("TARJ. BANCARIA", lineas, value = TRUE)
  if (length(linea_tarjeta) > 0) {
    datos$tarjeta <- gsub(".*\\*+\\s*([0-9]{4}).*", "\\1", linea_tarjeta[1])
  } else {
    datos$tarjeta <- NA
  }
    
  
  return(datos)
  
}


```

Creamos una función para procesar todos los tickets.

```{r}
#Función para procesar múltiples tickets PDF.

procesar_tickets <- function(directorio = "data") {
  
  # Listar todos los archivos PDF en el directorio
  archivos <- list.files(path = directorio, pattern = "\\.pdf$", full.names = TRUE)
  
  # Inicializar lista para almacenar resultados
  lista_tickets <- list()
  
  c<- 1
  # Procesar cada archivo
  for (i in seq_along(archivos)) {
    archivo <- archivos[i]
    cat("Procesando:", basename(archivo), "...\n")
  
  tryCatch({
      # Leer y procesar el PDF
      lineas <- leer_pdf(archivo)
      if (es_mercadona(lineas)){
        
        datos_ticket <- procesar_lineas(lineas)
      
        # Agregar nombre del archivo a los datos
        datos_ticket$archivo <- basename(archivo)
        
        # Almacenar en la lista
        lista_tickets[[c]] <- datos_ticket
        c <- c+1
        
      }
    }, error = function(e) {
      warning("Error al procesar el archivo ", basename(archivo), ": ", e$message)
      #lista_tickets[[i]] <- NULL
    })
  }
  
  # Filtrar elementos NULL (archivos que no se pudieron procesar)
  lista_tickets <- Filter(Negate(is.null), lista_tickets)
  
  return(lista_tickets)
}

# Procesar todos los tickets en la carpeta data
todos_los_tickets <- procesar_tickets()

# Vemos los tres primeros tickets procesados correctamente (aquellos pdfs de Mercadona con formato texto)
print(todos_los_tickets[[1]])

print(todos_los_tickets[[2]])

print(todos_los_tickets[[3]])



# Ver cuántos tickets se procesaron correctamente
length(todos_los_tickets) #Se procesan correctamente 306


```



Creamos un dataframe a parir de la lista de tickets 

```{r}
# Vamos a convertir la lista de tickets en un dataframe (cada fila es un ticket y cada columna una variable).

tickets_a_dataframe <- function(lista_tickets) {
  df <- do.call(rbind, lapply(lista_tickets, function(ticket) {
    data.frame(
      archivo = ticket$archivo,
      supermercado = ticket$supermercado,
      direccion = ticket$direccion,
      telefono = ticket$telefono,
      cp = ticket$cp,
      localidad = ticket$localidad,
      fecha = ticket$fecha,
      hora = ticket$hora,
      op = ticket$op,
      factura_simplificada = ticket$factura_simplificada,
      num_tienda = ticket$num_tienda,
      num_caja = ticket$num_caja,
      factura_numero = ticket$factura_numero,
      importe_total = ticket$importe_total,
      subtotal = ticket$subtotal,
      IVA = ticket$IVA,
      descuento = ticket$descuento,
      donacion = ticket$donacion,
      metodo_pago = ticket$metodo_pago,
      tarjeta = ticket$tarjeta,
      parking = ticket$parking,
      hora_entrada_parking = ticket$hora_entrada_parking,
      hora_salida_parking = ticket$hora_salida_parking,
      stringsAsFactors = FALSE
    )
  }))
  return(df)
}


# Con la función convertimos la lista a dataframe
df_tickets <- tickets_a_dataframe(todos_los_tickets)
df_tickets #Mostramos el contenido del dataframe

#Utilizamos la función kable() para representar la tabla

kable(df_tickets, caption = "Tabla 1: Resumen de tickets de Mercadona procesados \\label{tab:ejemplo-tickets}" )

```

Los resultados, mostrados en la Tabla \@ref(tab:ejemplo-tickets), revelan que

```{r}

#Nos hacemos una idea del tipo de dato de cada columna.

#Y por tanto, vamos a cambiar el tipo de dato de las siguientes columnas:


table(df_tickets$hora, useNA="ifany")


df_tickets<- df_tickets %>% mutate(
  fecha = dmy(fecha), #Cambiamos la columna de fecha a tipo fecha
 #Cambiamos las horas a fromato hm
  hora = hm(hora),
      
  hora_entrada_parking =
      hm(hora_entrada_parking),

  hora_salida_parking =
      hm(hora_salida_parking)
)
#Revisar hora_entrada_parking, hora_salida_parking, descuento y donación

str(df_tickets)


```



Comenzamos a responder a las preguntas:

¿Cuáles son los 5 productos, de los vendidos por unidades, con más ventas ? 
¿Cuántas unidades de cada uno se han vendido ?

```{r}

#Creamos una lista con todos los productos de los tickets del dataframe
todos_los_productos <- bind_rows(lapply(todos_los_tickets, function(ticket) ticket$productos))

#Filtramos los productos a aquellos que se venden por unidades
todos_productos_unidades <- todos_los_productos %>% filter(
    cantidad %% 1 == 0,  # cantidad entera
    !grepl("kg|€/kg", descripcion, ignore.case = TRUE)  # no se menciona peso
  )

#Agrupamos los productos por nombre
todos_productos_unidades <- todos_productos_unidades %>% group_by(descripcion)

#Sumamos las cantidades de todos los productos que tienen el mismo nombre
todos_productos_unidades <- todos_productos_unidades %>% summarise(unidades_vendidas = sum(cantidad, na.rm = TRUE)) 

#Ordenamos los productos de manera descendente
todos_productos_unidades <- todos_productos_unidades %>% arrange(desc(unidades_vendidas)) 

#Cogemos los cinco primeros productos de la tabla
todos_productos_unidades <- todos_productos_unidades %>% slice_head(n = 5)

#Mostramos los cinco productos comprados por unidades más vendidos.
print(todos_productos_unidades)

```

2.Si consideramos la categoría de FRUTAS Y VERDURAS. Cuáles son los 5 productos 
más vendidos ? ¿Cuántos kilos se han vendido de cada uno de estos productos?

```{r}

# Filtrar productos de frutas y verduras
frutas_verduras <- todos_los_productos %>%
  filter(str_detect(descripcion, "^1.*\\(.*kg.*\\)"))

# Extraer los kilos vendidos de la descripción
frutas_verduras <- frutas_verduras %>%
  mutate(kilos_vendidos = as.numeric(str_extract(descripcion, "(?<=\\()\\d+\\.\\d{3}")))

# Agrupar por el nombre del producto sin el "1" de delante
frutas_verduras_mas_vendidas <- frutas_verduras %>%
  mutate(producto = str_remove(str_extract(descripcion, "^[^\\(]+"), "^1 ")) %>%
  group_by(producto) %>%
  summarise(kilos_totales = sum(kilos_vendidos)) %>%
  arrange(desc(kilos_totales)) %>%
  head(5)

# Ver los resultados
print(productos_mas_vendidos)


```

3.Si consideramos la categoría de PESCADO. Cuáles son los 5 productos más vendidos?
¿Cuántos kilos se han vendido de cada uno de estos productos ?

```{r}

# Filtramos los productos que pertenecen a la categoria pescado de la lista de todos
#los productos
pescado <- todos_los_productos %>%
  filter(str_detect(descripcion, "^((?!^1).)*\\(.*kg.*\\)"))

# Extraemos los kilos vendidos de la descripción
pescado <- pescado %>%
  mutate(kilos_vendidos = as.numeric(str_extract(descripcion, "(?<=\\()\\d+\\.\\d{3}")))

# Agrupamos por nombre del producto y sumamos los kilos vendidos
pescados_mas_vendidos <- pescado %>%
  mutate(producto = str_extract(descripcion, "^[^\\(]+")) %>%
  group_by(producto) %>%
  summarise(kilos_totales = sum(kilos_vendidos)) %>%
  arrange(desc(kilos_totales)) %>%
  head(5)

# Mostramos los 5 pescados más vendidos junto a los kilos totales vendidos
print(productos_mas_vendidos_pescado)

```

4. Muestra mediante un gráfico de líneas como ha variado el precio por kilo de las 
bananas y los plátanos en los tickets disponibles, a lo largo del tiempo.

```{r}

library(dplyr)
library(ggplot2)

#Seleccionamos de la lista con toda la información todos los productos y su fecha de venta 
todos_los_productos <- bind_rows(lapply(todos_los_tickets, function(ticket) {
  if (nrow(ticket$productos) > 0) { 
    ticket_productos <- ticket$productos
    ticket_productos$fecha <- ticket$fecha
    return(ticket_productos)
  } else {
    return(NULL)
  }
}))

# Filtramos las bananas y los plátanos
frutas <- todos_los_productos %>% filter(str_detect(tolower(descripcion), "banana|platano")) 


#Seleccionamos el precio del kilo que se encuentra al lado del nombre del producto
frutas <- frutas %>% 
  mutate(precio_kilo = as.numeric(str_extract(descripcion, "(?<=a )\\d+\\.\\d{2}"))) 

#Comprobamos que las fechas se encuntren en el formato correcto
frutas$fecha <- as.Date(frutas$fecha, format = "%d/%m/%Y") 

# Normalizamos los nombres (banana vs platano)
frutas <- frutas %>%
  mutate(tipo = case_when(
    str_detect(tolower(descripcion), "banana") ~ "Banana",
    str_detect(tolower(descripcion), "platano") ~ "Platano"
  ))

# Creamos la gráfica con la evolución del precio por kilo
ggplot(frutas, aes(x = fecha, y = precio_kilo, color = tipo)) +
  geom_line() +
  labs(
    title = "Variación del precio por kilo: Bananas vs Plátanos",
    x = "Fecha",
    y = "Precio por kilo (€)",
    color = "Producto"
  ) +
  theme_minimal()

```

5.- ¿ Cuál es la procedencia de los tickets ?¿ Qué ciudad/ pueblo tiene un mayor número de tickets ?
```{r}
tickets_por_localidad <- df_tickets %>%
  group_by(localidad) %>%
  summarise(num_tickets = n()) %>%
  arrange(desc(num_tickets))


kable(tickets_por_localidad, caption = "Número de tickets por ciudad/pueblo")

localidad_top <- tickets_por_localidad %>% slice(1)
cat("La ciudad/pueblo con mayor número de tickets es:", localidad_top$localidad, 
    "con", localidad_top$num_tickets, "tickets.\n")

localidad_top


```
Podemos ver que la ciudad/pueblo que mas tickets tiene es Valencia con 121, y le siguen Alboraya y Alcoy. Tiene sentido, ya que es la capital y la localidad con mas habitantes de la provincia de Valencia y de la CV, y por tanto es mas probable que haya alumnos con tickets de Valencia.

6.- Muestra mediante un diagrama el número de tickets recogidos cada día de las semana. ¿Si tuvieses que cerrar un día entre semana qué día lo harías ?
```{r}

tickets_por_dia <- df_tickets %>%
  mutate(dia_semana = wday(fecha, label = TRUE, abbr = FALSE, week_start = 1, locale = "es_ES.UTF-8")) %>%
  count(dia_semana)


kable(tickets_por_dia, caption = "Número de tickets por día de la semana")


ggplot(tickets_por_dia, aes(x = dia_semana, y = n, fill = dia_semana)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  labs(title = "Número de tickets por día de la semana",
       x = "Día de la semana", y = "Número de tickets") +
  theme_minimal()

```
Teniendo en cuenta que el domingo no está abierto ningún Mercadona(excepto ciertos casos muy concretos), deberíamos cerrar el jueves ya que es el dia que menos compras se registran.



Las preguntas que nos hemos planteado son:

1. ¿Cuáles son los 5 productos más comprados? ¿Y cuántas veces ha sido comprado el qué más?
```{r}
top10_productos <- todos_los_productos %>%
  group_by(descripcion) %>%
  summarise(total_comprado = sum(cantidad, na.rm = TRUE)) %>%
  arrange(desc(total_comprado)) %>%
  slice_head(n = 10)


print(top10_productos)

top5_productos <- todos_los_productos %>%
  group_by(descripcion) %>%
  summarise(total_comprado = sum(cantidad, na.rm = TRUE)) %>%
  arrange(desc(total_comprado)) %>%
  slice_head(n = 5)


print(top5_productos)

producto_mas_comprado <- top5_productos %>% slice(1)
cat("El producto más comprado es:", producto_mas_comprado$descripcion, 
    "con", producto_mas_comprado$total_comprado, "unidades compradas.\n")
```
Los 5 poductos mas vendidos son el Atun Claro Oliva, el Queso Lonchas Cabra, la BOLSA PLASTICO,	
la LECHE DESNAT. CALCIO y el YOGUR COCO. El que mas, que es el ATUN CLARO OLIVA, se ha comprado 62 veces.


2. ¿A qué tienda (calle ...) pertenecen la mayor parte de los tickets? 
```{r}
tickets_por_direccion <- df_tickets %>%
  group_by(direccion) %>%
  summarise(num_tickets = n()) %>%
  arrange(desc(num_tickets))


direccion_top <- tickets_por_direccion %>% slice(1)

print(tickets_por_direccion) 
direccion_top
```
La tienda (calle) con mayor número de tickets es: C/ QUART 120 con 51 tickets.

3. ¿En qué horario (mañana o tarde) se hacen las compras más caras?

```{r}
df_tickets <- df_tickets %>%
  mutate(
    periodo_dia = ifelse(hour(hora) < 12, "Mañana", "Tarde")
  )

compras_por_periodo <- df_tickets %>% filter(!is.na(periodo_dia)) %>%
  group_by(periodo_dia) %>%
  summarise(
    media_importe = mean(importe_total, na.rm = TRUE),
    mediana_importe = median(importe_total, na.rm = TRUE)
  )

kable(compras_por_periodo, caption = "Importe medio por periodo del día")



```

El resultado muestra que, en promedio, las compras realizadas por la mañana son más caras (51.69€) que las realizadas por la tarde (45.64 €). La mediana también es ligeramente más alta por la mañana (36.69 € vs. 37.38 € por la tarde), aunque la diferencia en medianas es mínima.


4. ¿Cuál ha sido el ticket más caro registrado? ¿Y el más barato?

```{r}
ticket_mas_caro<- df_tickets %>% arrange(desc(importe_total)) %>% head(1)

ticket_mas_barato<- df_tickets %>% arrange(importe_total) %>% head(1)

cat("El ticket más caro es", ticket_mas_caro$archivo, "con un importe de: ", ticket_mas_caro$importe_total, "€", "\n")

cat("El ticket más barato es", ticket_mas_barato$archivo, "con un importe de: ", ticket_mas_barato$importe_total, "€")





```
Ya hemos obtenido el ticket más caro registrado con más de 200€ de diferencia con respecto al más barato.


5.¿Cómo de frecuentes son las compras de emergencia (tickets de menos de 10€)?

```{r}
compras_emergencia<- df_tickets %>% summarise(n_emergencia = sum(importe_total < 10, na.rm = TRUE),
porcentaje = mean(importe_total < 10, na.rm = TRUE) *100)


cat("Número de compras de emergencia:", compras_emergencia$n_emergencia, "\n")

cat("Porcentaje sobre el total:", compras_emergencia$porcentaje, "%", "\n")


```

6. ¿Qué día de la semana es el que menos compras registra?

```{r}
df_tickets<- df_tickets %>% filter(!is.na(fecha)) %>% mutate(dia_semana = format(fecha, "%A"))

compras_por_dia<-df_tickets %>% group_by(dia_semana) %>% summarise(n_compras = n()) %>% arrange(n_compras)

kable(compras_por_dia, caption = "Compras por día de la semana")


```

Obtenemos que el día de la semana en el que menos se compra es el Domingo con solamente 2 compras.



11. ¿Cuál es la mayor cantidad pagada de impuestos y en qué localización se ha producido?
```{r}

# Obtenemos el índice de la fila con mayor IVA
indice_max_iva <- which.max(df_tickets$IVA)

# Verificamos que el índice es válido
if (!is.na(indice_max_iva) && indice_max_iva > 0) {
  fila_max_iva <- df_tickets[indice_max_iva, ]
  
  # Extraemos el IVA y la localidad
  mayor_iva <- fila_max_iva$IVA
  localizacion_max_iva <- fila_max_iva$localidad
  
  # Mostramos el resultado
  cat("La mayor cantidad pagada de impuestos es:", mayor_iva,
      "y se ha producido en:", localizacion_max_iva, "\n")
} else {
  cat("No se pudo determinar la mayor cantidad pagada de impuestos.\n")
}

```

 
12. ¿Cuál es el producto más caro?

 
13. ¿Qué días presentan mayor volumen de ventas? ¿Se observan picos específicos durante la semana?

 
 
