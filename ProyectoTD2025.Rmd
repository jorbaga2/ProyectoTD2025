---
title: "ProyectoTD2025"
author: "Jorge Ballesteros García, Emma Almenar García, Miguel Angel Aloy Poveda, Ainhoa
  Larios Bea, Samuel Lozada Borrás, Iker Martínez Bravo"
date: "2025-04-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Instalación de las librerías.

```{r}
install.packages("pdftools")


```

Importación de las librerías:

```{r}

library(pdftools)
library(dplyr)
library(stringr)

```

Vamos a crear una función que procese un ticket individual


```{r}

# Función para leer PDF y convertir en líneas de texto procesadas
leer_pdf <- function(archivo) {
  texto <- pdf_text(archivo)
  lineas <- unlist(strsplit(paste(texto, collapse = "\n"), "\n"))
  trimws(lineas)
}


#Función que busca "MERCADONA" en mayúsculas.
es_mercadona <- function(lineas) {
  if(length(lineas) == 0) return(FALSE)
  any(grepl("^MERCADONA\\b", lineas))  # ^ indica inicio de línea, \b para palabra completa
}

# Función para procesar las líneas y extraer información
procesar_lineas <- function(lineas) {
  if(!es_mercadona(lineas)) {
    message("El texto no corresponde a un ticket de Mercadona")
    return(NULL)
  }
  
#Inicializamos una lista para almacenar datos. Esta lista incluye los datos de tanto el encabezado, como los productos
  
  datos<-list(
    supermercado = NA,
    direccion = NA,
    cp = NA,
    localidad = NA,
    telefono = NA,
    fecha = NA,
    hora = NA,
    op = NA,
    factura_simplificada = NA,
    
#Creamos dentro de la lista para almacenar los datos, un dataframe que va a contener los productos del ticket.
    
    productos = data.frame(
      cantidad = numeric(),
      descripcion = character(),
      importe = numeric(),
      stringsAsFactors = FALSE
    ),
    parking = FALSE,
    hora_entrada_parking = NA,
    hora_salida_parking = NA,
    donacion = NA,
    metodo_pago = NA,
    tarjeta = NA,
    subtotal = NA,
    descuento = NA,
    IVA = NA,
    importe_total = NA
  )
  
  
  #Procesar encabezado:
  
  #Extraer el supermercado
  datos$supermercado<- trimws(lineas[1])
  datos$supermercado
  
  #Extraer la dirección
  datos$direccion<- trimws(lineas[2])
  datos$direccion
  
  #Extraer CP y localidad (ejemplo: "04630 GARRUCHA")
  
  localidad_cp<- trimws(lineas[3]) #Usamos trimws para asegurarnos de eliminar los espacios en blanco anteriores al CP.
  localidad_cp #CP y localidad juntos
  
  datos$cp<- gsub("([0-9]+).*", "\\1", localidad_cp) #Extraemos solo el CP.
  datos$cp
  
  datos$localidad<- gsub("[0-9]+ (.*)", "\\1", localidad_cp) #Extraemos solo la localidad
  
  datos$localidad
  
  #Extraer teléfono
  telefono_linea<-lineas[4]
  datos$telefono<- gsub(".*TELÉFONO: (.*)", "\\1", telefono_linea)
  datos$telefono
  
  #Extraer fecha, hora y OP
  fecha_hora_linea<- trimws(lineas[5]) # 25/11/2023 09:09 OP: 78800
  partes<-unlist(strsplit(fecha_hora_linea, " ")) #Separamos los elementos por espacios
  datos$fecha<-partes[1]
  datos$fecha
  datos$hora<- partes[2]
  datos$hora
  datos$op<- paste(partes[3],partes[4]) #Unimos los dos elementos en una cadena ("OP: 78800")
  datos$op
  
  #Extraer de la factura simplificada el código del ticket y el código del supermercado
  linea_factura_simplificada <- lineas[6]
  factura_simplifcada <- trimws(gsub("FACTURA SIMPLIFICADA:", "", linea_factura_simplificada))  
  componentes_factura_simplificada <- unlist(strsplit(linea_factura_simplificada, "-"))
  datos$num_tienda <- componentes_factura_simplificada[1] 
  datos$factura_numero <- componentes_factura_simplificada[3]
  
    # Función para buscar la línea de inicio de los productos
  buscar_inicio_productos <- function(lineas) {
    return(grep("^\\s*Descripción\\s+P\\. Unit\\s+Importe", lineas))
  }
  
  # Función para buscar la línea de fin de los productos
  buscar_fin_productos <- function(lineas) {
    return(grep("^\\s*TOTAL \\(€\\)", lineas)[1] - 1)
  }
  
  # Función para extraer los productos normales (cantidad, descripción, importe)
  extraer_producto <- function(linea) {
   match <- str_match(linea, "^\\s*(\\d+(?:[.,]\\d+)?)\\s+(.*?)\\s+(\\d+[.,]\\d+)$")
   if (!is.na(match[1,1])) {
     cantidad <- as.numeric(gsub(",", ".", match[1,2]))
      descripcion <- trimws(match[1,3])
     importe <- as.numeric(gsub(",", ".", match[1,4]))
     return(data.frame(cantidad = cantidad, descripcion = descripcion, importe = importe, stringsAsFactors = FALSE))
   }
   return(NULL)
  }
  
  # Función para extraer productos normales (cantidad, descripción, [precio_unitario], importe)
  extraer_producto <- function(linea) {
  # Caso con precio_unitario y total
  match_con_unitario <- str_match(linea, "^\\s*(\\d+(?:[.,]\\d+)?)\\s+(.*?)\\s+(\\d+[.,]\\d+)\\s+(\\d+[.,]\\d+)$")
  if (!is.na(match_con_unitario[1,1])) {
    cantidad <- as.numeric(gsub(",", ".", match_con_unitario[1,2]))
    descripcion <- trimws(match_con_unitario[1,3])
    precio_unitario <- as.numeric(gsub(",", ".", match_con_unitario[1,4]))
    importe <- as.numeric(gsub(",", ".", match_con_unitario[1,5]))
    return(data.frame(cantidad = cantidad, descripcion = descripcion, precio_unitario = precio_unitario, importe = importe, stringsAsFactors = FALSE))
  }

  # Caso sin precio_unitario
  match_simple <- str_match(linea, "^\\s*(\\d+(?:[.,]\\d+)?)\\s+(.*?)\\s+(\\d+[.,]\\d+)$")
  if (!is.na(match_simple[1,1])) {
    cantidad <- as.numeric(gsub(",", ".", match_simple[1,2]))
    descripcion <- trimws(match_simple[1,3])
    importe <- as.numeric(gsub(",", ".", match_simple[1,4]))
    return(data.frame(cantidad = cantidad, descripcion = descripcion, precio_unitario = NA, importe = importe, stringsAsFactors = FALSE))
  }

  
  # Función para procesar productos y agregar datos
  procesar_productos <- function(lineas) {
    linea_inicio_productos <- buscar_inicio_productos(lineas)
    if (length(linea_inicio_productos) > 0) {
     inicio <- linea_inicio_productos + 1
      fin <- buscar_fin_productos(lineas)

      if (!is.na(fin) && inicio < fin) {
        productos_brutos <- lineas[inicio:fin]
        i <- 1
        productos <- data.frame(cantidad = numeric(), descripcion = character(), importe = numeric(), stringsAsFactors = FALSE)

        while (i <= length(productos_brutos)) {
          linea <- productos_brutos[i]
        
         # Intentamos extraer el producto normal
          producto <- extraer_producto(linea)
          if (!is.null(producto)) {
            productos <- rbind(productos, producto)
            i <- i + 1
          } else {
            # Intentamos extraer un producto a peso si no es normal
            if (i < length(productos_brutos)) {
              linea_actual <- productos_brutos[i]
              linea_siguiente <- productos_brutos[i + 1]

             producto_peso <- extraer_producto_peso(linea_actual, linea_siguiente)
              if (!is.null(producto_peso)) {
                productos <- rbind(productos, producto_peso)
                i <- i + 2  # saltamos 2 líneas
              } else {
              i <- i + 1
              }
            } else {
              i <- i + 1
            }
          }
        }
        return(productos)
      }
    }
    return(NULL)
  }
  
  # Función extraer_producto_peso
  extraer_producto_peso <- function(linea_actual, linea_siguiente) {
    match_peso <- str_match(linea_siguiente, "([0-9.,]+)\\s*kg\\s+([0-9.,]+)\\s*€/kg\\s+([0-9.,]+)")
   if (!is.na(match_peso[1,1])) {
     cantidad <- 1
     descripcion <- trimws(linea_actual)
      peso <- gsub(",", ".", match_peso[1,2])
      precio_kg <- gsub(",", ".", match_peso[1,3])
      importe <- gsub(",", ".", match_peso[1,4])
      descripcion_completa <- paste0(descripcion, " (", peso, " kg a ", precio_kg, " €/kg)")
      return(data.frame(cantidad = cantidad, descripcion = descripcion_completa, precio_unitario = as.numeric(precio_kg), importe = as.numeric(importe), stringsAsFactors = FALSE))
    }
    return(NULL)
  }


  # Llamamos a procesar_productos para extraer los productos del ticket
  productos_extraidos <- procesar_productos(lineas)
  if (!is.null(productos_extraidos)) {
    datos$productos <- productos_extraidos  # Asignamos los productos al dataframe dentro de datos
  }  

  #Extraer IVA y subtotal
  linea_total_iva <- grep("^TOTAL\\s+[0-9.,]+\\s+[0-9.,]+$", lineas, value = TRUE)
  if (length(linea_total_iva) > 0) {
    partes <- unlist(strsplit(gsub(",", ".", linea_total_iva[1]), "\\s+"))
    datos$subtotal <- as.numeric(partes[2])
    datos$IVA <- as.numeric(partes[3])
  } else {
    datos$subtotal <- NA
    datos$IVA <- NA
  }
  
  #Extraer importe total
  linea_total <- grep("TOTAL \\(€\\)", lineas, value = TRUE)[1]
  if (!is.na(linea_total)) {
    datos$importe_total <- as.numeric(gsub(",", ".", gsub(".*TOTAL \\(€\\)\\s*([0-9.,]+).*", "\\1", linea_total)))
  } else {
    datos$importe_total <- NA
  }
  
  #Extraer descuento
  linea_descuento <- grep("DESCUENTO|DTO", lineas, value = TRUE, ignore.case = TRUE)
  if (length(linea_descuento) > 0) {
    datos$descuento <- as.numeric(gsub(",", ".", gsub(".*([0-9]+,[0-9]{2}).*", "\\1", linea_descuento[1])))
  } else {
    datos$descuento <- NA
  }
  
  #Extraer donación
  linea_donacion <- grep("DONACIÓN", lineas, value = TRUE)
  if (length(linea_donacion) > 0) {
    datos$donacion <- as.numeric(gsub(",", ".", gsub(".*DONACIÓN:\\s*([0-9.,]+).*", "\\1", linea_donacion[1])))
  } else {
    datos$donacion <- NA
  }
  
  #Extraer parking (hora entrada y salida si hay)
  linea_parking <- grep("PARKING", lineas, value = TRUE)
  if (length(linea_parking) > 0) {
    datos$parking <- TRUE
    datos$hora_entrada_parking <- gsub(".*ENTRADA:\\s*([0-9:]+).*", "\\1", linea_parking)
    datos$hora_salida_parking <- gsub(".*SALIDA:\\s*([0-9:]+).*", "\\1", linea_parking)
  } else {
    datos$parking <- FALSE
  }
  
  #Extraer método de pago
  linea_pago <- grep("TARJETA|MASTERCARD|EFECTIVO|DEBIT", lineas, value = TRUE, ignore.case = TRUE)
  if (length(linea_pago) > 0) {
    metodo <- grep("MASTERCARD|VISA|EFECTIVO|DEBIT|TARJETA", linea_pago, value = TRUE, ignore.case = TRUE)
    if (length(metodo) > 0) {
      datos$metodo_pago <- toupper(gsub(".*(MASTERCARD|VISA|DEBIT|EFECTIVO|TARJETA).*", "\\1", metodo[1]))
    } else {
      datos$metodo_pago <- NA
    }
  }
  
  #Extraer tarjeta
  linea_tarjeta <- grep("TARJ. BANCARIA", lineas, value = TRUE)
  if (length(linea_tarjeta) > 0) {
    datos$tarjeta <- gsub(".*\\*+\\s*([0-9]{4}).*", "\\1", linea_tarjeta[1])
  } else {
    datos$tarjeta <- NA
  }
    
  
  return(datos)
  
}

#Utilizaremos este fichero de prueba para probar la función de procesamiento.

#f_prueba<-"data/20231125 Mercadona 37,76 €.pdf"

f_prueba<- "data/ticket_dia_30_10_2024_11_56.pdf"

lineas<- leer_pdf(f_prueba)

datos<- procesar_lineas(lineas)
print(datos)




```


Inspección de los tickets.

```{r}
#Listar todos los archivos PDF presentes en la carpeta 'data'.

archivos<- list.files(path = 'data', pattern = '\\.pdf$', full.names = TRUE)

#Creamos una dataframe vacío en el que vamos a ir añadiendo los datos del encabezado.

encabezado_pdf<- data.frame(
  Nombre_supermercado = character(),
  Direccion = character()
  
)



```


